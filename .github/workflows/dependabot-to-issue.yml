name: Create Dependabot Issues

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Fetch open Dependabot alerts
        id: fetch_alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FINEGRAINED }}
          script: |
            const response = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });
            return response.data;

      - name: Create issues for alerts ‚â• moderate
        uses: actions/github-script@v7
        env:
          ALERTS_PAYLOAD: ${{ steps.fetch_alerts.outputs.result }}
        with:
          github-token: ${{ secrets.GH_PAT_FINEGRAINED }}
          script: |
            // Puedes ajustar aqu√≠ tu umbral m√≠nimo:
            const allowedSeverities = ['low','moderate','high','critical'];
            const minSeverity    = 'moderate';               // 'low', 'moderate', 'high' o 'critical'
            const thresholdIndex = allowedSeverities.indexOf(minSeverity);

            const alerts = JSON.parse(process.env.ALERTS_PAYLOAD);
            console.log(`üîî Total alertas encontradas: ${alerts.length}`);

            for (const alert of alerts) {
              // seguridad: descartar alertas sin advisory o dependency
              if (!alert.security_advisory || !alert.dependency?.package) {
                console.log('‚ùå Alerta incompleta, salto:', alert);
                continue;
              }

              const sev = alert.security_advisory.severity.toLowerCase();
              console.log(`‚ö†Ô∏è Severidad detectada: ${sev}`);

              // filtrar por umbral
              if (allowedSeverities.indexOf(sev) < thresholdIndex) {
                console.log(`   ‚Ü≥ Severidad "${sev}" por debajo de "${minSeverity}", salto.`);
                continue;
              }

              // preparar t√≠tulo y cuerpo
              const pkg   = alert.dependency.package;
              const title = `üö® [${sev.toUpperCase()}] ${alert.security_advisory.summary} ‚Äî ${pkg.name}`;
              const body  = [
                `### ‚ö†Ô∏è Vulnerabilidad (Severidad: ${sev.toUpperCase()})`,
                ``,
                `**Paquete afectado:** \`${pkg.name}\`  `,
                `**Ecosistema:** ${pkg.ecosystem}  `,
                `**Resumen:** ${alert.security_advisory.summary}  `,
                ``,
                `**Descripci√≥n completa:**`,
                alert.security_advisory.description,
                ``,
                `**Dependabot URL:** [Ver alerta](${alert.html_url})`,
                ``,
                `---`,
                `Este issue ha sido generado autom√°ticamente.`
              ].join('\n');

              // comprobar duplicados
              const { data: existing } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                labels: "dependabot,security"
              });
              if (existing.find(i => i.title === title)) {
                console.log('   ‚Ü≥ Issue ya existe, salto.');
                continue;
              }

              // crear issue
              console.log('   ‚Ü≥ Creando issue:', title);
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ["dependabot","security"]
              });
            }
