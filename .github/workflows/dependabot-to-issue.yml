name: Create Dependabot Issues

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  create-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      security-events: read
    steps:
      - name: Fetch open Dependabot alerts
        id: fetch_alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FINEGRAINED }}
          script: |
            const response = await github.rest.dependabot.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });
            return response.data;

      - name: Create issues for all alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT_FINEGRAINED }}
          script: |
            const alerts = JSON.parse(process.env.ALERTS_PAYLOAD);

            for (const alert of alerts) {
              if (!alert.security_advisory || !alert.dependency?.package) continue;

              const advisory = alert.security_advisory;
              const dependency = alert.dependency;
              const pkg = dependency.package;

              const severity = advisory.severity || "UNKNOWN";
              const title = `ðŸ›¡ï¸ [${severity}] ${advisory.summary} in ${pkg.ecosystem}:${pkg.name}`;

              const identifiers = advisory.identifiers.map(
                id => `- **${id.type}**: ${id.value}`
              ).join("\n");

              const body = [
                `## ðŸ“¦ Paquete afectado`,
                `- **Nombre:** \`${pkg.name}\``,
                `- **Ecosistema:** ${pkg.ecosystem}`,
                ``,
                `## âš ï¸ Vulnerabilidad`,
                `- **Severidad:** ${severity}`,
                `- **Resumen:** ${advisory.summary}`,
                ``,
                `## ðŸ§  DescripciÃ³n`,
                `${advisory.description}`,
                ``,
                `## ðŸ†” Identificadores`,
                identifiers || "_No hay identificadores disponibles._",
                ``,
                `## ðŸ”— Enlace a la alerta`,
                `[Ver en Dependabot](${alert.html_url})`,
                ``,
                `---`,
                `Este issue fue generado automÃ¡ticamente desde Dependabot.`
              ].join("\n");

              const { data: existingIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                labels: "dependabot,security"
              });

              const exists = existingIssues.find(i => i.title === title);
              if (!exists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title,
                  body,
                  labels: ["dependabot", "security"]
                });
              }
            }
        env:
          ALERTS_PAYLOAD: ${{ toJson(steps.fetch_alerts.outputs.result) }}
